<div class="form-container">
  <div class="form-header">
    <h2>{{ isEditMode ? "Editar" : "Crear" }} Orden de Trabajo</h2>
  </div>

  <form [formGroup]="ordenForm" (ngSubmit)="onSubmit()" class="form-body">
    <div class="form-row">
      <div class="form-group">
        <label for="folio">Folio *</label>
        <input
          type="number"
          id="folio"
          formControlName="folio"
          class="form-control"
          [class.error]="folio?.invalid && folio?.touched"
          placeholder="1"
          min="1"
          step="1"
          inputmode="numeric"
          (blur)="onFolioBlur()"
        />
        <div class="error-message" *ngIf="folio?.invalid && folio?.touched">
          {{ getErrorMessage("folio") }}
        </div>
      </div>

      <div class="form-group">
        <label for="horasTrabajo">Horas de Trabajo *</label>
        <input
          type="number"
          id="horasTrabajo"
          formControlName="horasTrabajo"
          class="form-control"
          [class.error]="horasTrabajo?.invalid && horasTrabajo?.touched"
          placeholder="1"
          step="1"
          min="1"
          inputmode="numeric"
        />
        @if (horasTrabajo?.invalid && horasTrabajo?.touched) {
          <div class="error-message">
            {{ getErrorMessage("horasTrabajo") }}
          </div>
        }
      </div>
    </div>

    <div class="form-row">
      <div class="form-group">
        <label for="rutCliente">Cliente *</label>
        <select
          id="rutCliente"
          formControlName="rutCliente"
          class="form-control"
          [class.error]="rutCliente?.invalid && rutCliente?.touched"
        >
          <option value="">Seleccione cliente</option>
          <option *ngFor="let c of clientesActivos" [value]="c.rut">
            {{ c.razonSocial }} {{ c.rut }} - {{ c.dv }}
          </option>
        </select>
        <div
          class="error-message"
          *ngIf="rutCliente?.invalid && rutCliente?.touched"
        >
          {{ getErrorMessage("rutCliente") }}
        </div>
      </div>

      <div class="form-group">
        <label for="fechaAgendada">Fecha Agendada *</label>
        <input
          type="datetime-local"
          id="fechaAgendada"
          formControlName="fechaAgendada"
          class="form-control"
          [class.error]="fechaAgendada?.invalid && fechaAgendada?.touched"
        />
        <div
          class="error-message"
          *ngIf="fechaAgendada?.invalid && fechaAgendada?.touched"
        >
          {{ getErrorMessage("fechaAgendada") }}
        </div>
      </div>
    </div>
    <div class="form-row">
        <div class="form-group comuna-selector">
        <label for="idComuna">Comuna y Región *</label>
        <app-comuna-region-selector id="idComuna" formControlName="idComuna">
        </app-comuna-region-selector>
        <div
          class="error-message"
          *ngIf="idComuna?.invalid && idComuna?.touched"
        >
          {{ getErrorMessage("idComuna") }}
        </div>
      </div>
    </div>
    <div class="form-row">
      <div class="form-group full-width">
        <label for="direccion">Dirección *</label>
        <input
          type="text"
          id="direccion"
          formControlName="direccion"
          class="form-control"
          [class.error]="direccion?.invalid && direccion?.touched"
          placeholder="Ingrese la dirección completa"
        />
        <div
          class="error-message"
          *ngIf="direccion?.invalid && direccion?.touched"
        >
          {{ getErrorMessage("direccion") }}
        </div>
      </div>
    </div>

    <div class="form-row">
      <div class="form-group full-width">
        <label for="observaciones">Observaciones</label>
        <textarea
          id="observaciones"
          formControlName="observaciones"
          class="form-control"
          [class.error]="observaciones?.invalid && observaciones?.touched"
          placeholder="Observaciones adicionales (opcional)"
          rows="4"
        >
        </textarea>
        <div
          class="error-message"
          *ngIf="observaciones?.invalid && observaciones?.touched"
        >
          {{ getErrorMessage("observaciones") }}
        </div>
      </div>
    </div>

    <div class="form-row">
      <div class="form-group full-width">
        <app-lista-asignacion-empleado
          [fechaAgendada]="fechaAgendada?.value"
          [horasTrabajo]="horasTrabajo?.value"
          [preseleccion]="[]"
          (empleadosSeleccionChange)="onEmpleadosSeleccionados($event)"
        >
        </app-lista-asignacion-empleado>
      </div>
    </div>

    <div class="form-row">
      <div class="form-group full-width">
        <app-lista-asignacion-vehiculo
          [fechaAgendada]="fechaAgendada?.value"
          [horasTrabajo]="horasTrabajo?.value"
          [(vehiculoAsignado)]="selectedVehiculo"
          (vehiculoAsignadoChange)="onVehiculoSeleccionadoChange($event)">
        </app-lista-asignacion-vehiculo>
        <div class="error-message" *ngIf="vehiculoSeleccionadoTouched && vehiculoSeleccionadoError">
          {{ getVehiculoSeleccionadoErrorMessage() }}
        </div>
      </div>
    </div>

    <div class="form-actions">
      <button type="button" class="btn btn-secondary" (click)="onCancel()">
        Cancelar
      </button>
      <button
        type="button"
        class="btn btn-outline"
        (click)="onReset()"
        *ngIf="!isEditMode"
      >
        Limpiar
      </button>
      <button
        type="submit"
        class="btn btn-primary"
        [disabled]="ordenForm.invalid || loading || !selectedVehiculo"
      >
        {{ isEditMode ? "Actualizar" : "Crear" }} Orden
      </button>
    </div>
  </form>

  <div class="error-alert" *ngIf="error">
    {{ error }}
  </div>
</div>

